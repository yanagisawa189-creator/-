<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIOチェッカー - 管理者ダッシュボード</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            color: #1e3a8a;
            font-size: 36px;
            font-weight: 800;
        }

        .header p {
            color: #64748b;
            font-size: 16px;
            margin-top: 8px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab {
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #1e3a8a;
            white-space: nowrap;
        }

        .tab:hover {
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .tab.active {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(245, 158, 11, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: #1e3a8a;
        }

        .stat-change {
            font-size: 13px;
            margin-top: 8px;
            font-weight: 600;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        .section {
            background: white;
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-title {
            font-size: 24px;
            color: #1e3a8a;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th {
            background: #f1f5f9;
            padding: 15px;
            text-align: left;
            font-size: 13px;
            font-weight: 700;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
            color: #334155;
        }

        .data-table tr:hover {
            background: #f8fafc;
        }

        .status-pill {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pill.success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-pill.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-pill.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-pill.info {
            background: #dbeafe;
            color: #1e40af;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        .chart-card {
            background: #f9fafb;
            border-radius: 12px;
            padding: 25px;
        }

        .chart-card h3 {
            font-size: 18px;
            color: #1e3a8a;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .config-form {
            display: grid;
            gap: 20px;
        }

        .form-group {
            display: grid;
            gap: 8px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: #334155;
        }

        .form-input {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .keyword-manager {
            display: grid;
            gap: 15px;
        }

        .keyword-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f9fafb;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
        }

        .keyword-info {
            flex: 1;
        }

        .keyword-name {
            font-size: 16px;
            font-weight: 600;
            color: #1e3a8a;
            margin-bottom: 5px;
        }

        .keyword-meta {
            font-size: 13px;
            color: #6b7280;
        }

        .keyword-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .icon-btn.edit {
            background: #dbeafe;
            color: #1e40af;
        }

        .icon-btn.delete {
            background: #fee2e2;
            color: #991b1b;
        }

        .icon-btn:hover {
            transform: scale(1.1);
        }

        .system-logs {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.8;
        }

        .log-entry {
            margin-bottom: 8px;
        }

        .log-time {
            color: #94a3b8;
        }

        .log-level {
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 4px;
            margin: 0 8px;
        }

        .log-level.info {
            background: #1e40af;
            color: white;
        }

        .log-level.warn {
            background: #d97706;
            color: white;
        }

        .log-level.error {
            background: #991b1b;
            color: white;
        }

        .api-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .api-card {
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
        }

        .api-card.active {
            border-color: #10b981;
            background: linear-gradient(135deg, #d1fae5 0%, #ffffff 100%);
        }

        .api-card.inactive {
            border-color: #ef4444;
            background: linear-gradient(135deg, #fee2e2 0%, #ffffff 100%);
        }

        .api-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .api-name {
            font-size: 16px;
            font-weight: 700;
            color: #1e3a8a;
        }

        .api-status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .api-status-dot.active {
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
        }

        .api-status-dot.inactive {
            background: #ef4444;
            box-shadow: 0 0 10px #ef4444;
        }

        .api-details {
            font-size: 13px;
            color: #64748b;
            line-height: 1.6;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        input[type="file"] {
            display: none;
        }

        @media (max-width: 768px) {
            .stats-overview {
                grid-template-columns: 1fr;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>⚙️ 管理者ダッシュボード</h1>
                    <p>AIO表示チェッカー - システム管理コンソール</p>
                </div>
                <div class="header-actions">
                    <label for="file-upload" class="btn btn-primary">
                        <span>📁</span>
                        <span>データ読込</span>
                    </label>
                    <input id="file-upload" type="file" accept=".json" onchange="loadData(event)">
                    <button class="btn btn-success" onclick="exportAllData()">
                        <span>💾</span>
                        <span>CSV出力</span>
                    </button>
                    <button class="btn btn-warning" onclick="refreshData()">
                        <span>🔄</span>
                        <span>更新</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('overview')">📊 概要</button>
            <button class="tab" onclick="switchTab('keywords')">🔑 キーワード管理</button>
            <button class="tab" onclick="switchTab('apis')">🌐 API状態</button>
            <button class="tab" onclick="switchTab('analytics')">📈 詳細分析</button>
            <button class="tab" onclick="switchTab('config')">⚙️ システム設定</button>
            <button class="tab" onclick="switchTab('logs')">📋 ログ</button>
        </div>

        <!-- 概要タブ -->
        <div id="overview" class="tab-content active">
            <div class="stats-overview">
                <div class="stat-card">
                    <div class="stat-icon">🎯</div>
                    <div class="stat-label">総実行回数</div>
                    <div class="stat-value" id="total-runs">0</div>
                    <div class="stat-change positive" id="runs-change">+0%</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">✅</div>
                    <div class="stat-label">成功率</div>
                    <div class="stat-value" id="success-rate">0%</div>
                    <div class="stat-change positive" id="success-change">+0%</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">⭐</div>
                    <div class="stat-label">AIO引用率</div>
                    <div class="stat-value" id="aio-rate">0%</div>
                    <div class="stat-change positive" id="aio-change">+0%</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">🤖</div>
                    <div class="stat-label">LLM引用率</div>
                    <div class="stat-value" id="llm-rate">0%</div>
                    <div class="stat-change positive" id="llm-change">+0%</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">📈</div>
                    <div class="stat-label">平均順位</div>
                    <div class="stat-value" id="avg-position">-</div>
                    <div class="stat-change positive" id="position-change">+0</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">🔍</div>
                    <div class="stat-label">監視キーワード</div>
                    <div class="stat-value" id="total-keywords-stat">0</div>
                    <div class="stat-change info">アクティブ</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <span>📊</span>
                        <span>最新実行結果</span>
                    </h2>
                </div>
                <table class="data-table" id="recent-results">
                    <thead>
                        <tr>
                            <th>実行日時</th>
                            <th>キーワード</th>
                            <th>エンジン</th>
                            <th>デバイス</th>
                            <th>AIO表示</th>
                            <th>自社引用</th>
                            <th>順位</th>
                            <th>ステータス</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="8" class="no-data">データが読み込まれていません</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="chart-grid">
                <div class="chart-card">
                    <h3>時系列トレンド</h3>
                    <canvas id="trendChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>LLMエンジン別パフォーマンス</h3>
                    <canvas id="llmPerfChart"></canvas>
                </div>
            </div>
        </div>

        <!-- キーワード管理タブ -->
        <div id="keywords" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <span>🔑</span>
                        <span>監視キーワード一覧</span>
                    </h2>
                    <button class="btn btn-primary" onclick="addKeyword()">
                        <span>➕</span>
                        <span>新規追加</span>
                    </button>
                </div>
                <div class="keyword-manager" id="keyword-list">
                    <div class="no-data">キーワードデータを読み込んでください</div>
                </div>
            </div>
        </div>

        <!-- API状態タブ -->
        <div id="apis" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <span>🌐</span>
                        <span>外部API接続状態</span>
                    </h2>
                </div>
                <div class="api-status-grid">
                    <div class="api-card" id="serpapi-status">
                        <div class="api-header">
                            <div class="api-name">SerpAPI</div>
                            <div class="api-status-dot"></div>
                        </div>
                        <div class="api-details">
                            <div>ステータス: <strong>未確認</strong></div>
                            <div>最終実行: -</div>
                            <div>成功率: -%</div>
                        </div>
                    </div>

                    <div class="api-card" id="claude-status">
                        <div class="api-header">
                            <div class="api-name">Claude API</div>
                            <div class="api-status-dot"></div>
                        </div>
                        <div class="api-details">
                            <div>ステータス: <strong>未確認</strong></div>
                            <div>最終実行: -</div>
                            <div>成功率: -%</div>
                        </div>
                    </div>

                    <div class="api-card" id="chatgpt-status">
                        <div class="api-header">
                            <div class="api-name">ChatGPT API</div>
                            <div class="api-status-dot"></div>
                        </div>
                        <div class="api-details">
                            <div>ステータス: <strong>未確認</strong></div>
                            <div>最終実行: -</div>
                            <div>成功率: -%</div>
                        </div>
                    </div>

                    <div class="api-card" id="gemini-status">
                        <div class="api-header">
                            <div class="api-name">Gemini API</div>
                            <div class="api-status-dot"></div>
                        </div>
                        <div class="api-details">
                            <div>ステータス: <strong>未確認</strong></div>
                            <div>最終実行: -</div>
                            <div>成功率: -%</div>
                        </div>
                    </div>

                    <div class="api-card" id="sheets-status">
                        <div class="api-header">
                            <div class="api-name">Google Sheets</div>
                            <div class="api-status-dot"></div>
                        </div>
                        <div class="api-details">
                            <div>ステータス: <strong>未確認</strong></div>
                            <div>最終実行: -</div>
                            <div>成功率: -%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 詳細分析タブ -->
        <div id="analytics" class="tab-content">
            <div class="section">
                <h2 class="section-title">
                    <span>📈</span>
                    <span>詳細パフォーマンス分析</span>
                </h2>
                <div class="chart-grid">
                    <div class="chart-card">
                        <h3>検索エンジン別成功率</h3>
                        <canvas id="engineSuccessChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>デバイス別AIO表示率</h3>
                        <canvas id="deviceAioChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>順位分布</h3>
                        <canvas id="rankDistChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>LLM引用詳細</h3>
                        <canvas id="llmDetailChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- システム設定タブ -->
        <div id="config" class="tab-content">
            <div class="section">
                <h2 class="section-title">
                    <span>⚙️</span>
                    <span>システム設定</span>
                </h2>
                <div class="config-form">
                    <div class="form-group">
                        <label class="form-label">SerpAPI キー</label>
                        <input type="password" class="form-input" placeholder="your_serpapi_key_here" value="••••••••••••">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Anthropic API キー (Claude)</label>
                        <input type="password" class="form-input" placeholder="sk-ant-..." value="••••••••••••">
                    </div>

                    <div class="form-group">
                        <label class="form-label">OpenAI API キー (ChatGPT)</label>
                        <input type="password" class="form-input" placeholder="sk-..." value="••••••••••••">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Google AI API キー (Gemini)</label>
                        <input type="password" class="form-input" placeholder="AI..." value="••••••••••••">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Google Sheets ID</label>
                        <input type="text" class="form-input" placeholder="1ABC...xyz">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ターゲットドメイン（カンマ区切り）</label>
                        <textarea class="form-input form-textarea" placeholder="example.com, your-domain.com"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">実行スケジュール</label>
                        <select class="form-input">
                            <option>毎日 9:00</option>
                            <option>毎週月曜 9:00</option>
                            <option>手動実行のみ</option>
                        </select>
                    </div>

                    <button class="btn btn-success" style="justify-self: start;">
                        <span>💾</span>
                        <span>設定を保存</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ログタブ -->
        <div id="logs" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <span>📋</span>
                        <span>システムログ</span>
                    </h2>
                    <button class="btn btn-primary" onclick="clearLogs()">
                        <span>🗑️</span>
                        <span>ログクリア</span>
                    </button>
                </div>
                <div class="system-logs" id="system-logs">
                    <div class="log-entry">
                        <span class="log-time">[2025-10-08 12:30:45]</span>
                        <span class="log-level info">INFO</span>
                        <span>システム起動完了</span>
                    </div>
                    <div class="log-entry">
                        <span class="log-time">[2025-10-08 12:31:00]</span>
                        <span class="log-level info">INFO</span>
                        <span>SerpAPI接続成功</span>
                    </div>
                    <div class="log-entry">
                        <span class="log-time">[2025-10-08 12:31:05]</span>
                        <span class="log-level info">INFO</span>
                        <span>Claude API接続成功</span>
                    </div>
                    <div class="log-entry">
                        <span class="log-time">[2025-10-08 12:31:10]</span>
                        <span class="log-level warn">WARN</span>
                        <span>Google Sheets credentials not found - using mock data</span>
                    </div>
                    <div class="log-entry">
                        <span class="log-time">[2025-10-08 12:31:15]</span>
                        <span class="log-level info">INFO</span>
                        <span>キーワード設定読み込み完了: 2件</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;
        let charts = {};

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function loadData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    currentData = Array.isArray(data) ? data : [data];
                    updateDashboard(currentData);
                    addLog('info', `データ読み込み完了: ${currentData.length}件`);
                } catch (error) {
                    addLog('error', 'データ読み込みエラー: ' + error.message);
                    alert('ファイルの読み込みに失敗しました');
                }
            };
            reader.readAsText(file);
        }

        function updateDashboard(data) {
            // 統計更新
            const totalRuns = data.length;
            const successRuns = data.filter(d => d.job_status === 'ok').length;
            const successRate = Math.round((successRuns / totalRuns) * 100);

            const aioPresent = data.filter(d => d.aio_present).length;
            const aioRate = Math.round((aioPresent / totalRuns) * 100);

            let llmCitations = 0, llmTotal = 0;
            data.forEach(d => {
                if (d.llm_results) {
                    llmTotal += d.llm_results.length;
                    llmCitations += d.llm_results.filter(llm => llm.llm_own_cited).length;
                }
            });
            const llmRate = llmTotal > 0 ? Math.round((llmCitations / llmTotal) * 100) : 0;

            const rankedResults = data.filter(d => d.serp_rank && d.serp_rank > 0);
            const avgPosition = rankedResults.length > 0
                ? Math.round(rankedResults.reduce((sum, d) => sum + d.serp_rank, 0) / rankedResults.length)
                : '-';

            const uniqueKeywords = new Set(data.map(d => d.keyword)).size;

            document.getElementById('total-runs').textContent = totalRuns;
            document.getElementById('success-rate').textContent = successRate + '%';
            document.getElementById('aio-rate').textContent = aioRate + '%';
            document.getElementById('llm-rate').textContent = llmRate + '%';
            document.getElementById('avg-position').textContent = avgPosition === '-' ? avgPosition : avgPosition + '位';
            document.getElementById('total-keywords-stat').textContent = uniqueKeywords;

            // テーブル更新
            updateResultsTable(data);

            // キーワード一覧更新
            updateKeywordList(data);

            // API状態更新
            updateApiStatus(data);

            // チャート更新
            updateCharts(data);
        }

        function updateResultsTable(data) {
            const tbody = document.querySelector('#recent-results tbody');
            tbody.innerHTML = '';

            data.slice(0, 10).forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(result.run_at).toLocaleString('ja-JP')}</td>
                    <td><strong>${result.keyword}</strong></td>
                    <td>${result.engine.toUpperCase()}</td>
                    <td>${result.device === 'desktop' ? '🖥️ PC' : '📱 モバイル'}</td>
                    <td><span class="status-pill ${result.aio_present ? 'success' : 'warning'}">${result.aio_present ? '表示あり' : '表示なし'}</span></td>
                    <td><span class="status-pill ${result.own_cited ? 'success' : 'info'}">${result.own_cited ? '引用あり' : '引用なし'}</span></td>
                    <td>${result.serp_rank || '圏外'}</td>
                    <td><span class="status-pill ${result.job_status === 'ok' ? 'success' : 'error'}">${result.job_status === 'ok' ? '成功' : '失敗'}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateKeywordList(data) {
            const container = document.getElementById('keyword-list');
            const keywords = {};

            data.forEach(d => {
                if (!keywords[d.keyword]) {
                    keywords[d.keyword] = {
                        keyword: d.keyword,
                        lang: d.lang,
                        device: d.device,
                        runs: 0,
                        success: 0
                    };
                }
                keywords[d.keyword].runs++;
                if (d.job_status === 'ok') keywords[d.keyword].success++;
            });

            container.innerHTML = '';
            Object.values(keywords).forEach(kw => {
                const item = document.createElement('div');
                item.className = 'keyword-item';
                item.innerHTML = `
                    <div class="keyword-info">
                        <div class="keyword-name">${kw.keyword}</div>
                        <div class="keyword-meta">言語: ${kw.lang} | デバイス: ${kw.device} | 実行回数: ${kw.runs} | 成功率: ${Math.round((kw.success/kw.runs)*100)}%</div>
                    </div>
                    <div class="keyword-actions">
                        <button class="icon-btn edit" onclick="editKeyword('${kw.keyword}')">✏️</button>
                        <button class="icon-btn delete" onclick="deleteKeyword('${kw.keyword}')">🗑️</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function updateApiStatus(data) {
            // Mock API status based on data
            const hasSerp = data.some(d => d.serp_top100 && d.serp_top100.length > 0);
            const hasClaude = data.some(d => d.llm_results && d.llm_results.find(llm => llm.llm_engine === 'claude'));
            const hasChatGPT = data.some(d => d.llm_results && d.llm_results.find(llm => llm.llm_engine === 'chatgpt'));
            const hasGemini = data.some(d => d.llm_results && d.llm_results.find(llm => llm.llm_engine === 'gemini'));

            updateApiCard('serpapi-status', hasSerp);
            updateApiCard('claude-status', hasClaude);
            updateApiCard('chatgpt-status', hasChatGPT);
            updateApiCard('gemini-status', hasGemini);
        }

        function updateApiCard(cardId, isActive) {
            const card = document.getElementById(cardId);
            const dot = card.querySelector('.api-status-dot');
            const details = card.querySelector('.api-details');

            if (isActive) {
                card.classList.add('active');
                card.classList.remove('inactive');
                dot.classList.add('active');
                dot.classList.remove('inactive');
                details.innerHTML = `
                    <div>ステータス: <strong style="color: #10b981;">正常</strong></div>
                    <div>最終実行: 数分前</div>
                    <div>成功率: 98%</div>
                `;
            } else {
                card.classList.add('inactive');
                card.classList.remove('active');
                dot.classList.add('inactive');
                dot.classList.remove('active');
                details.innerHTML = `
                    <div>ステータス: <strong style="color: #ef4444;">未使用</strong></div>
                    <div>最終実行: -</div>
                    <div>成功率: -%</div>
                `;
            }
        }

        function updateCharts(data) {
            // Trend Chart (simplified)
            const trendCtx = document.getElementById('trendChart');
            if (charts.trend) charts.trend.destroy();
            charts.trend = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: data.slice(0, 10).map((d, i) => `実行${i+1}`),
                    datasets: [{
                        label: 'AIO表示率',
                        data: data.slice(0, 10).map(d => d.aio_present ? 100 : 0),
                        borderColor: '#10b981',
                        tension: 0.4
                    }]
                },
                options: { responsive: true }
            });

            // LLM Performance Chart
            const llmPerfCtx = document.getElementById('llmPerfChart');
            if (charts.llmPerf) charts.llmPerf.destroy();

            const llmStats = { claude: 0, chatgpt: 0, gemini: 0 };
            data.forEach(d => {
                if (d.llm_results) {
                    d.llm_results.forEach(llm => {
                        if (llm.llm_own_cited) llmStats[llm.llm_engine]++;
                    });
                }
            });

            charts.llmPerf = new Chart(llmPerfCtx, {
                type: 'bar',
                data: {
                    labels: ['Claude', 'ChatGPT', 'Gemini'],
                    datasets: [{
                        label: '引用獲得数',
                        data: [llmStats.claude, llmStats.chatgpt, llmStats.gemini],
                        backgroundColor: ['#ff6b35', '#10a37f', '#4285f4']
                    }]
                },
                options: { responsive: true }
            });
        }

        function addKeyword() {
            alert('キーワード追加機能は開発中です');
        }

        function editKeyword(keyword) {
            alert(`キーワード「${keyword}」の編集機能は開発中です`);
        }

        function deleteKeyword(keyword) {
            if (confirm(`キーワード「${keyword}」を削除しますか？`)) {
                alert('削除機能は開発中です');
            }
        }

        function exportAllData() {
            if (!currentData) {
                alert('エクスポートするデータがありません');
                return;
            }
            alert('CSV出力機能は開発中です');
        }

        function refreshData() {
            alert('データ更新機能は開発中です');
        }

        function clearLogs() {
            document.getElementById('system-logs').innerHTML = '<div class="log-entry"><span class="log-time">[' + new Date().toLocaleString() + ']</span><span class="log-level info">INFO</span><span>ログをクリアしました</span></div>';
        }

        function addLog(level, message) {
            const logsContainer = document.getElementById('system-logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-time">[${new Date().toLocaleString()}]</span>
                <span class="log-level ${level}">${level.toUpperCase()}</span>
                <span>${message}</span>
            `;
            logsContainer.appendChild(entry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }
    </script>
</body>
</html>
